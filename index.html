<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'>
    <!--<meta name="viewport" content="width=1280, height=720, initial-scale=1, maximum-scale=1">-->
    <title>Большой канон фанфиков</title>
    <!-- the following line is D3 package which does all the plotting on this page. It's free and awesome, and can be downloaded at d3js.org -->
    <script src="https://d3js.org/d3.v2.min.js"></script>
    <style type="text/css">

      html, body { margin:0; padding:0; overflow:visible }
svg { position:absolute; top:0; bottom:0; left:0; right:0 }

textarea
{
  width:100%;
}

line {
//  fill: 
  opacity: 0.8;
  stroke: #808000; 
 // stroke-width: 1.5px;
}

circle {
  opacity: 0.8;
  //fill: #fdd700;
  stroke: #333;
  stroke-width: 1.5px;
}

text {
  font: 10px sans-serif;
  pointer-events: none;
}

lines_labels
 {
  font: 16px sans-serif;
  pointer-events: none;
}

text.shadow {
  stroke: #fff;
  stroke-width: 3px;
  stroke-opacity: .8;
}

.svg-container {
    display: inline-block;
    position: relative;
    width: 100%;
    padding-bottom: 100%; /* aspect ratio */
    vertical-align: top;
    overflow: hidden;
}
.svg-content-responsive {
    display: inline-block;
    position: absolute;
    top: 10px;
    left: 0;
}

 .button {
        top: 0%; 
        position: absolute;
        border-radius: 10px;
        width: 100px;
        height: 50px;
        z-index: 2;
    }

.instr
    {
        z-index:100;
        width:500px;
        height:500px;
        background-color: #ffffff;
        margin:auto;
        position:fixed;
        top: 10px;
        left: 300px;
        border: 1px solid;
        border-radius: 5px;
        word-wrap: break-word;
        white-space:pre-wrap;
        padding:10px;
    }

    </style>

  </head>
  

  <body style="background: rgb(255, 255, 255) repeat scroll top left; margin: 0pt; ">

     <!-- -->



    <script  type="module"> 

      var a=document.getElementById("viz");

      var faq = document.createElement("button");
      faq.className = faq.className + "button";
      faq.textContent='Как это работает?';
      faq.onclick = function(){
      var d= document.createElement("div");
                    d.className=d.className+'instr';
                    d.id='manual'+Math.random()*1000;
                    
                    d.style.height="200px";
                    d.style.width="500px";
                    var rules="Как это работает?\n"+String.fromCodePoint(128994)+" — канон.\n"+String.fromCodePoint(128993)+" — фанфики. \nМожно таскать мышью и залипать.\nПо нажатию на кружок открывается ссылка на текст (подозреваю, что только с компьютера).\nЕсли чего-то не хватает, можно добавить по соответствующей кнопке.\n\n";
                    var tn = document.createTextNode(rules);
                    
                    var btn = document.createElement("button");
                    btn.className = btn.className + "button";
                    btn.textContent='Понятно';
                    btn.style.position="relative";
                    btn.style.left="200px";
                    btn.style.align="center";
                    btn.onclick = function() {document.getElementById(d.id).style.display = "none"; };

                    d.appendChild(tn);
                    d.appendChild(btn);
                    a.appendChild(d);

                    }; 
      a.appendChild(faq);

      var feedback = document.createElement("button");
      feedback.className = feedback.className + "button";
      feedback.textContent='Тут не хватает!';
      feedback.style.left="100px";
      feedback.onclick = function(){
    var d1= document.createElement("div");
                    d1.className=d1.className+'instr';
                    d1.id='fb'+Math.random()*1000;
                    
                    d1.style.height="500px";
                    d1.style.width="500px";
                    
                    var tn1 = document.createTextNode("Я знаю еще фанфики! Вставьте сюда ссылки:\n");
                    var ta1= document.createElement('textarea');
                    ta1.id='newnodes';
                    var ta2= document.createElement('textarea');
                    ta2.id='newlinks';
                    var ta3= document.createElement('textarea');
                    ta3.id='words';
                    var tn2 = document.createTextNode("\nОно сильнее сплетается! Напишите сюда связи:\n");

                    var tn3 = document.createTextNode("\nЯ просто хочу высказаться:\n");
                    
                    var tn4 = document.createTextNode("\n\n");
                    var btn2 = document.createElement("button");
                    btn2.className = btn2.className + "button";
                    btn2.textContent='Отправить!';
                    btn2.style.position="relative";
                    btn2.style.left="100px";
                    btn2.style.align="center";
                    btn2.onclick = function() {
                      var http = new XMLHttpRequest();
                      var url = 'https://api.telegram.org/bot5041328563:AAHSUMqtWJN1TV-enQoauWAIwf-g97qA1cc/sendMessage';
                      http.open('POST', url, true);
                      http.setRequestHeader('Content-Type', 'application/json');
                      http.onreadystatechange = function() {//Call a function when the state changes.
                            if(http.readyState == 4 && http.status == 200) {
                            //alert(http.responseText);
                            }
                      }
                      http.send(JSON.stringify({"chat_id": "-807254052", "text": "NODES: "+document.getElementById("newnodes").value+"     LINKS: "+document.getElementById("newlinks").value+"    FEEDBACK: "+document.getElementById("words").value, "disable_notification": true}));
                      document.getElementById(d1.id).style.display = "none"; };

                    var btn3 = document.createElement("button");
                    btn3.className = btn3.className + "button";
                    btn3.textContent='Не хочу!';
                    btn3.style.position="relative";
                    btn3.style.left="200px";
                    btn3.style.align="center";
                    btn3.onclick = function() {
                      document.getElementById(d1.id).style.display = "none"; };
                    d1.appendChild(tn1);
                    d1.appendChild(ta1);
                    d1.appendChild(tn2);
                    d1.appendChild(ta2);
                    d1.appendChild(tn3);
                    d1.appendChild(ta3);
                    d1.appendChild(tn4);
                    d1.appendChild(btn2);
                    d1.appendChild(btn3);
                    a.appendChild(d1);
                    document.getElementById(d1.id).innerHtml+='<span id="close2" onclick="this.parentNode.parentNode.remove(); return false;">x</span>';
                    };
      a.appendChild(feedback);

      var lst = document.createElement("button");
      lst.className = lst.className + "button";
      lst.textContent='Смотреть списком';
      lst.onclick = function(){window.location.href='list.html';};
      //lst.href="list.html";
      lst.style.left="200px";
      a.appendChild(lst);
      

import data from './json.json' assert { type: 'json' };
var links = data.links;

var nodes = data.nodes;

//console.log(links.filter(l => l.source==0));

var w = window.screen.width,
    h = window.screen.height-100,
    l = 60,
    r = 20,
    ch = -1500;


var force = d3.layout.force()
    .nodes(d3.values(nodes))
    .links(links)
    .size([w, h])
    .linkDistance(l)
    .charge(ch)
    .on("tick", tick)
    .start();

    var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");



var path = svg.append("svg:g").selectAll("link")
    .data(force.links())
  .enter().append("svg:line")  .attr("stroke-width",2)  
             .attr("marker-end","url(#arrow)");
//       .attr("stroke", "#222");
//    .attr("class", function(d) { return "link " + d.type; });



var text = svg.selectAll("node")
    .data(force.nodes())
  .enter().append("svg:a");


text.attr("xlink:href", function(d) { return (d.link ); });
//text.attr("xlink:href", function(d) { return ("papers/" + d.name + ".pdf"); });

text.append("svg:circle")
    .attr("r", r)
    .attr("alpha", .5)
    .attr("fill", function(d){if (d.canon) return "#6aaa64"; return "#fdd700";})
    .call(force.drag);

var lines_labels = svg.selectAll("link") //this is moved in this position so that circles don't overlap it
    .data(force.links())
       .enter().append("text")
       .attr("class","lines_labels") //dnw
       .text(function(d) { return  d.labelme; });



// A copy of the text with a thick white stroke for legibility.
text.append("svg:text")
    .attr("x", 0)
    .attr("y", 0)
    .attr("class", "shadow")
    .text(function(d) { return d.label; });

text.append("svg:text")
    .attr("x", 0)
    .attr("y", 0)
    .text(function(d) { return d.label; });

    

// Use elliptical arc path segments to doubly-encode directionality.
function tick() {

     path.attr("x1", function(d) { return d.source.x; })
         .attr("y1", function(d) { return d.source.y; })
         .attr("x2", function(d) { return d.target.x; })
         .attr("y2", function(d) { return d.target.y; });


     lines_labels.attr("x", function(d) { return (d.source.x+d.target.x)/2; })
         .attr("y", function(d) { return (d.source.y+d.target.y)/2; })

//  circle.attr("transform", function(d) {    return "translate(" + d.x + "," + d.y + ")";  });

  text.attr("transform", function(d) {
    return "translate(" + d.x + "," + d.y + ")";
  });
}



    </script>

<div style="width:window.screen.width; height:window.screen.height; border:0px solid rgb(221,217,205); margin-top: 0px; padding: 00px;" class="rounded box" id="viz">
<svg id="svg_1" xmlns="http://www.w3.org/2000/svg" width="2000" height="5000" viewbox="-50 -500 1950 4500">
<defs>
  <marker id='arrow' orient="auto"
    markerWidth='5' markerHeight='6'
    refX='3.9' refY='3'>
    <!-- triangle pointing right (+x) -->
    <path d='M0,0 V6 L3,3 Z'/>
  </marker>
</defs>


</svg>

  
    </div>

</body>
</html>

